/*
    jscoverage.js - code coverage for JavaScript
    Copyright (C) 2007, 2008, 2009, 2010 siliconforks.com

    This program is free software; you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation; either version 2 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License along
    with this program; if not, write to the Free Software Foundation, Inc.,
    51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
*/

function jscoverage_openWarningDialog(){var e;e=jscoverage_isReport?"reportWarningDialog":"warningDialog";var t=document.getElementById(e);t.style.display="block"}function jscoverage_closeWarningDialog(){var e;e=jscoverage_isReport?"reportWarningDialog":"warningDialog";var t=document.getElementById(e);t.style.display="none"}function jscoverage_init(e){try{return Components.utils["import"]("resource://app/modules/jscoverage.jsm"),void(jscoverage_isInvertedMode=!0)}catch(t){}if(e.opener)try{e.opener.top._$jscoverage?(jscoverage_isInvertedMode=!0,e._$jscoverage||(e._$jscoverage=e.opener.top._$jscoverage)):jscoverage_isInvertedMode=!1}catch(t){try{e.opener._$jscoverage?(jscoverage_isInvertedMode=!0,e._$jscoverage||(e._$jscoverage=e.opener._$jscoverage)):jscoverage_isInvertedMode=!1}catch(r){jscoverage_isInvertedMode=!1}}else jscoverage_isInvertedMode=!1;jscoverage_isInvertedMode||e._$jscoverage||(e._$jscoverage={})}function jscoverage_createRequest(){return window.ActiveXObject?new ActiveXObject("Microsoft.XMLHTTP"):new XMLHttpRequest}function jscoverage_findPos(e){var t=0;do t+=e.offsetTop,e=e.offsetParent;while(e);return t}function jscoverage_getViewportHeight(){if(self.innerHeight)return self.innerHeight;if(document.documentElement&&document.documentElement.clientHeight)return document.documentElement.clientHeight;if(document.body)return document.body.clientHeight;throw"Couldn't calculate viewport height"}function jscoverage_beginLengthyOperation(){jscoverage_inLengthyOperation=!0;var e=document.getElementById("progressBar");e.style.visibility="visible",ProgressBar.setPercentage(e,0);var t=document.getElementById("progressLabel");if(t.style.visibility="visible",!/Opera|WebKit/.test(navigator.userAgent)){var r,n=document.getElementById("tabs").getElementsByTagName("div");for(r=0;r<n.length;r++)n.item(r).style.cursor="wait"}}function jscoverage_endLengthyOperation(){var e=document.getElementById("progressBar");ProgressBar.setPercentage(e,100),setTimeout(function(){jscoverage_inLengthyOperation=!1,e.style.visibility="hidden";var t=document.getElementById("progressLabel");t.style.visibility="hidden",t.innerHTML="";var r,n=document.getElementById("tabs").getElementsByTagName("div");for(r=0;r<n.length;r++)n.item(r).style.cursor=""},50)}function jscoverage_setSize(){for(var e=jscoverage_getViewportHeight(),t=document.getElementById("tabPages"),r=e-jscoverage_findPos(t)-32+"px",n=t.childNodes,o=n.length,a=0;o>a;a++){var s=n.item(a);1===s.nodeType&&(s.style.height=r)}var c=document.getElementById("iframeDiv");c&&(c.style.height=e-jscoverage_findPos(c)-21+"px");var i=document.getElementById("summaryDiv");i.style.height=e-jscoverage_findPos(i)-21+"px";var d=document.getElementById("sourceDiv");d.style.height=e-jscoverage_findPos(d)-21+"px";var l=document.getElementById("storeDiv");l&&(l.style.height=e-jscoverage_findPos(l)-21+"px")}function jscoverage_getBooleanValue(e){return e=e.toLowerCase(),"false"===e||"f"===e||"no"===e||"n"===e||"off"===e||"0"===e?!1:!0}function jscoverage_removeTab(e){var t=document.getElementById(e+"Tab");t.parentNode.removeChild(t);var r=document.getElementById(e+"TabPage");r.parentNode.removeChild(r)}function jscoverage_isValidURL(e){var t=/^(([^:\/?#]+):)?(\/\/([^\/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/.exec(e);if(null===t)return!1;var r=t[1];return"string"==typeof r?(r=r.toLowerCase(),""===r||"file:"===r||"http:"===r||"https:"===r):!0}function jscoverage_initTabContents(e){var t,r,n,o,a,s,c=!1,i=null,d=null;if(e.length>0)for(e=e.substring(1),t=e.split(/&|;/),n=0;n<t.length;n++)r=t[n],o=r.indexOf("="),-1===o?i=decodeURIComponent(r):(a=r.substr(0,o),s=decodeURIComponent(r.substr(o+1)),"missing"===a||"m"===a?c=jscoverage_getBooleanValue(s):"url"===a||"u"===a||"frame"===a||"f"===a?i=s:("window"===a||"w"===a)&&(d=s));var l=document.getElementById("checkbox");l.checked=c,c&&jscoverage_appendMissingColumn();var g=function(e){var t=jscoverage_isValidURL(e);return t||alert("Invalid URL: "+e),t};null!==i&&g(i)?frames[0].location=i:null!==d&&g(d)&&window.open(d),document.getElementById("browserTab")||jscoverage_recalculateSummaryTab()}function jscoverage_body_load(){function reportError(e){jscoverage_endLengthyOperation();var t=document.getElementById("summaryThrobber");t.style.visibility="hidden";var r=document.getElementById("summaryErrorDiv");r.innerHTML="Error: "+e}if(window.location&&window.location.href&&/^file:/i.test(window.location.href)){var warningDiv=document.getElementById("warningDiv");warningDiv.style.display="block"}var progressBar=document.getElementById("progressBar");if(ProgressBar.init(progressBar),jscoverage_isReport){jscoverage_beginLengthyOperation();var summaryThrobber=document.getElementById("summaryThrobber");summaryThrobber.style.visibility="visible";var request=jscoverage_createRequest();try{request.open("GET","jscoverage.json",!0),request.onreadystatechange=function(event){if(4===request.readyState)try{if(0!==request.status&&200!==request.status)throw request.status;var response=request.responseText;if(""===response)throw 404;var json;json=window.JSON&&window.JSON.parse?window.JSON.parse(response):eval("("+response+")");var file;for(file in json)if(json.hasOwnProperty(file)){var fileCoverage=json[file];_$jscoverage[file]=fileCoverage.coverage,_$jscoverage[file].source=fileCoverage.source}jscoverage_recalculateSummaryTab(),summaryThrobber.style.visibility="hidden"}catch(e){reportError(e)}},request.send(null)}catch(e){reportError(e)}jscoverage_removeTab("browser"),jscoverage_removeTab("store")}else jscoverage_isInvertedMode&&jscoverage_removeTab("browser"),jscoverage_isServer||jscoverage_removeTab("store");jscoverage_initTabControl(),jscoverage_initTabContents(location.search)}function jscoverage_body_resize(){/MSIE/.test(navigator.userAgent)&&jscoverage_setSize()}function jscoverage_updateBrowser(){var e=document.getElementById("location");frames[0].location=e.value}function jscoverage_openWindow(){var e=document.getElementById("location"),t=e.value;window.open(t)}function jscoverage_input_keypress(e){13===e.keyCode&&(e.shiftKey?jscoverage_openWindow():jscoverage_updateBrowser())}function jscoverage_openInFrameButton_click(){jscoverage_updateBrowser()}function jscoverage_openInWindowButton_click(){jscoverage_openWindow()}function jscoverage_browser_load(){var e=document.getElementById("location");e&&(e.value=frames[0].location)}function jscoverage_createHandler(e,t){return function(){return jscoverage_get(e,t),!1}}function jscoverage_createLink(e,t){var r=document.createElement("a");r.href="#",r.onclick=jscoverage_createHandler(e,t);var n;return n=t?t.toString():e,r.appendChild(document.createTextNode(n)),r}function jscoverage_recalculateSummaryTab(e){var t=document.getElementById("checkbox"),r=t.checked;if(e||(e=window._$jscoverage),!e)throw"No coverage information found.";for(var n=document.getElementById("summaryTbody");n.hasChildNodes();)n.removeChild(n.firstChild);var o,a={files:0,statements:0,executed:0},s=[];for(o in e)e.hasOwnProperty(o)&&s.push(o);s.sort();for(var c=0,i=0;i<s.length;i++){o=s[i];var d,l=0,g=0,v=[],u=e[o],m=u.length,p=0,f=null;for(u.conditionals&&(f=u.conditionals),d=0;m>d;d++){var _=u[d];d===p?p=0:0===p&&f&&f[d]&&(p=f[d]),0===p&&void 0!==_&&null!==_&&(0===_?v.push(d):g++,l++)}var j=0===l?0:parseInt(100*g/l),y=document.createElement("tr");y.className=c++%2==0?"odd":"even";var h=document.createElement("td");h.className="leftColumn";var b=jscoverage_createLink(o);h.appendChild(b),y.appendChild(h),h=document.createElement("td"),h.className="numeric",h.appendChild(document.createTextNode(l)),y.appendChild(h),h=document.createElement("td"),h.className="numeric",h.appendChild(document.createTextNode(g)),y.appendChild(h),h=document.createElement("td"),h.className="coverage";var T=document.createElement("div"),B=document.createElement("div"),E=document.createElement("span");if(T.className="pctGraph",0===l?(B.className="skipped",E.appendChild(document.createTextNode("N/A"))):(B.className="covered",B.style.width=j+"px",E.appendChild(document.createTextNode(j+"%"))),E.className="pct",T.appendChild(B),h.appendChild(T),h.appendChild(E),y.appendChild(h),r){h=document.createElement("td");for(var I=0;I<v.length;I++){0!==I&&h.appendChild(document.createTextNode(", ")),b=jscoverage_createLink(o,v[I]);for(var w,C=v[I];;){for(w=1;I+w<v.length&&v[I+w]==v[I]+w;)w++;var N=v[I+w],L=v[I]+w;if(isNaN(N))break;for(;N>L&&!u[L];)L++;if(N>L||L>=m)break;I+=w}(C!=v[I]||w>1)&&(I+=w-1,b.innerHTML+="-"+v[I]),h.appendChild(b)}y.appendChild(h)}n.appendChild(y),a.files++,a.statements+=l,a.executed+=g;var O=document.getElementById("summaryTotals");if(O){var P=O.getElementsByTagName("td");P[0].getElementsByTagName("span")[1].firstChild.nodeValue=a.files,P[1].firstChild.nodeValue=a.statements,P[2].firstChild.nodeValue=a.executed;var x=parseInt(100*a.executed/a.statements);isNaN(x)&&(x=0),P[3].getElementsByTagName("span")[0].firstChild.nodeValue=x+"%",P[3].getElementsByTagName("div")[1].style.width=x+"px"}}jscoverage_endLengthyOperation()}function jscoverage_appendMissingColumn(){var e=document.getElementById("headerRow"),t=document.createElement("th");t.id="missingHeader",t.innerHTML='<abbr title="List of statements missed during execution">Missing</abbr>',e.appendChild(t);var r=document.getElementById("summaryTotals"),n=document.createElement("td");n.id="missingCell",r.appendChild(n)}function jscoverage_removeMissingColumn(){var e;e=document.getElementById("missingHeader"),e.parentNode.removeChild(e),e=document.getElementById("missingCell"),e.parentNode.removeChild(e)}function jscoverage_checkbox_click(){if(jscoverage_inLengthyOperation)return!1;jscoverage_beginLengthyOperation();var e=document.getElementById("checkbox"),t=e.checked;return setTimeout(function(){t?jscoverage_appendMissingColumn():jscoverage_removeMissingColumn(),jscoverage_recalculateSummaryTab()},50),!0}function jscoverage_makeTable(){function e(){o=a.join(""),ProgressBar.setPercentage(c,60),setTimeout(t,100)}function t(){var e=document.getElementById("sourceDiv");e.innerHTML=o,ProgressBar.setPercentage(c,80),setTimeout(jscoverage_scrollToLine,0)}var r=_$jscoverage[jscoverage_currentFile],n=r.source;n||(n=[]);for(var o,a=['<table id="sourceTable">'],s=0,c=document.getElementById("progressBar"),i=0;s<n.length;){var d=s+1;d===i?i=0:0===i&&r.conditionals&&r.conditionals[d]&&(i=r.conditionals[d]);var l="<tr>";l+='<td class="numeric">'+d+"</td>";var g=r[d];void 0!==g&&null!==g?(l+=0!==i?'<td class="y numeric">':0===g?'<td class="r numeric" id="line-'+d+'">':'<td class="g numeric">',l+=g,l+="</td>"):l+="<td></td>",l+="<td><pre>"+n[s]+"</pre></td>",l+="</tr>",l+="\n",a[d]=l,s++}a[s+1]="</table>",ProgressBar.setPercentage(c,40),setTimeout(e,0)}function jscoverage_scrollToLine(){if(jscoverage_selectTab("sourceTab"),!window.jscoverage_currentLine)return void jscoverage_endLengthyOperation();var e=document.getElementById("sourceDiv");if(1===jscoverage_currentLine)e.scrollTop=0;else{var t=document.getElementById("line-"+jscoverage_currentLine);if(t){var r=jscoverage_findPos(e),n=jscoverage_findPos(t);e.scrollTop=n-r}}jscoverage_currentLine=0,jscoverage_endLengthyOperation()}function jscoverage_get(e,t){jscoverage_inLengthyOperation||(jscoverage_beginLengthyOperation(),setTimeout(function(){var r=document.getElementById("sourceDiv");if(r.innerHTML="",jscoverage_selectTab("sourceTab"),e!==jscoverage_currentFile){if(null===jscoverage_currentFile){var n=document.getElementById("sourceTab");n.className="",n.onclick=jscoverage_tab_click}jscoverage_currentFile=e,jscoverage_currentLine=t||1;var o=document.getElementById("fileDiv");return o.innerHTML=jscoverage_currentFile,void jscoverage_recalculateSourceTab()}jscoverage_currentLine=t,jscoverage_recalculateSourceTab()},50))}function jscoverage_recalculateSourceTab(){if(!jscoverage_currentFile)return void jscoverage_endLengthyOperation();var e=document.getElementById("progressLabel");e.innerHTML="Calculating coverage ...";var t=document.getElementById("progressBar");ProgressBar.setPercentage(t,20),setTimeout(jscoverage_makeTable,0)}function jscoverage_initTabControl(){var e,t,r=document.getElementById("tabs"),n=0;for(e=0;e<r.childNodes.length;e++)t=r.childNodes.item(e),1===t.nodeType&&("disabled"!==t.className&&(t.onclick=jscoverage_tab_click),n++);jscoverage_selectTab(0)}function jscoverage_selectTab(e){"number"!=typeof e&&(e=jscoverage_tabIndexOf(e));var t,r,n,o,a=document.getElementById("tabs"),s=document.getElementById("tabPages");for(t=a.childNodes,r=0,n=0;n<t.length;n++)o=t.item(n),1===o.nodeType&&("disabled"!==o.className&&(r===e?o.className="selected":o.className=""),r++);for(t=s.childNodes,r=0,n=0;n<t.length;n++)o=t.item(n),1===o.nodeType&&(r===e?o.className="selected TabPage":o.className="TabPage",r++)}function jscoverage_tabIndexOf(e){"string"==typeof e&&(e=document.getElementById(e));var t,r,n=document.getElementById("tabs"),o=0;for(t=0;t<n.childNodes.length;t++)if(r=n.childNodes.item(t),1===r.nodeType){if(r===e)return o;o++}throw"Tab not found"}function jscoverage_tab_click(e){if(!jscoverage_inLengthyOperation){var t;e?t=e.target:window.event&&(t=window.event.srcElement),"selected"!==t.className&&(jscoverage_beginLengthyOperation(),setTimeout(function(){if("summaryTab"===t.id)for(var e=document.getElementById("summaryTbody");e.hasChildNodes();)e.removeChild(e.firstChild);else if("sourceTab"===t.id){var r=document.getElementById("sourceDiv");r.innerHTML=""}jscoverage_selectTab(t),"summaryTab"===t.id?jscoverage_recalculateSummaryTab():"sourceTab"===t.id?jscoverage_recalculateSourceTab():jscoverage_endLengthyOperation()},50))}}function jscoverage_pad(e){return"0000".substr(e.length)+e}function jscoverage_quote(e){return'"'+e.replace(/[\u0000-\u001f"\\\u007f-\uffff]/g,function(e){switch(e){case"\b":return"\\b";case"\f":return"\\f";case"\n":return"\\n";case"\r":return"\\r";case"	":return"\\t";case'"':return'\\"';case"\\":return"\\\\";default:return"\\u"+jscoverage_pad(e.charCodeAt(0).toString(16))}})+'"'}function jscoverage_serializeCoverageToJSON(){var e=[];for(var t in _$jscoverage)if(_$jscoverage.hasOwnProperty(t)){for(var r=_$jscoverage[t],n=[],o=r.length,a=0;o>a;a++){var s=r[a];(void 0===s||null===s)&&(s="null"),n.push(s)}var c=r.source,i=[];o=c.length;for(var a=0;o>a;a++)i.push(jscoverage_quote(c[a]));e.push(jscoverage_quote(t)+':{"coverage":['+n.join(",")+'],"source":['+i.join(",")+"]}")}return"{"+e.join(",")+"}"}function jscoverage_storeButton_click(){if(!jscoverage_inLengthyOperation){jscoverage_beginLengthyOperation();var e=document.getElementById("storeImg");e.style.visibility="visible";var t=jscoverage_createRequest();t.open("POST","/jscoverage-store",!0),t.onreadystatechange=function(e){if(4===t.readyState){var r;try{if(200!==t.status&&201!==t.status&&204!==t.status)throw t.status;r=t.responseText}catch(n){r=0===n.toString().search(/^\d{3}$/)?n+": "+t.responseText:"Could not connect to server: "+n}jscoverage_endLengthyOperation();var o=document.getElementById("storeImg");o.style.visibility="hidden";var a=document.getElementById("storeDiv");a.appendChild(document.createTextNode(new Date+": "+r)),a.appendChild(document.createElement("br"))}},t.setRequestHeader("Content-Type","application/json");var r=jscoverage_serializeCoverageToJSON();t.setRequestHeader("Content-Length",r.length.toString()),t.send(r)}}var jscoverage_currentFile=null,jscoverage_currentLine=null,jscoverage_inLengthyOperation=!1,jscoverage_isInvertedMode=!1,jscoverage_isServer=!1,jscoverage_isReport=!1;jscoverage_init(window);var ProgressBar={init:function(e){e._percentage=0,ProgressBar._update(e)},setPercentage:function(e,t){e._percentage=t,ProgressBar._update(e)},_update:function(e){var t=e.getElementsByTagName("div").item(0),r=t.getElementsByTagName("div").item(0),n=e.getElementsByTagName("span").item(0);n.innerHTML=e._percentage.toString()+"%",r.style.width=e._percentage+"px"}};