!function(){function t(t,e){var n=domUtils.getNodeIndex;t=t.duplicate(),t.collapse(e);var r=t.parentElement();if(!r.hasChildNodes())return{container:r,offset:0};for(var a,i,o=r.children,s=t.duplicate(),l=0,c=o.length-1,d=-1;c>=l;){d=Math.floor((l+c)/2),a=o[d],s.moveToElementText(a);var h=s.compareEndPoints("StartToStart",t);if(h>0)c=d-1;else{if(!(0>h))return{container:r,offset:n(a)};l=d+1}}if(-1==d){if(s.moveToElementText(r),s.setEndPoint("StartToStart",t),i=s.text.replace(/(\r\n|\r)/g,"\n").length,o=r.childNodes,!i)return a=o[o.length-1],{container:a,offset:a.nodeValue.length};for(var u=o.length;i>0;)i-=o[--u].nodeValue.length;return{container:o[u],offset:-i}}if(s.collapse(h>0),s.setEndPoint(h>0?"StartToStart":"EndToStart",t),i=s.text.replace(/(\r\n|\r)/g,"\n").length,!i)return dtd.$empty[a.tagName]||dtd.$nonChild[a.tagName]?{container:r,offset:n(a)+(h>0?0:1)}:{container:a,offset:h>0?0:a.childNodes.length};for(;i>0;)try{var f=a;a=a[h>0?"previousSibling":"nextSibling"],i-=a.nodeValue.length}catch(g){return{container:r,offset:n(f)}}return{container:a,offset:h>0?-i:a.nodeValue.length+i}}function e(e,n){if(e.item)n.selectNode(e.item(0));else{var r=t(e,!0);n.setStart(r.container,r.offset),0!=e.compareEndPoints("StartToEnd",e)&&(r=t(e,!1),n.setEnd(r.container,r.offset))}return n}function n(t){var e;try{e=t.getNative().createRange()}catch(n){return null}var r=e.item?e.item(0):e.parentElement();return(r.ownerDocument||r)===t.document?e:null}var r=dom.Selection=function(t){var e,r=this;r.document=t,browser.ie9below&&(e=domUtils.getWindow(t).frameElement,domUtils.on(e,"beforedeactivate",function(){r._bakIERange=r.getIERange()}),domUtils.on(e,"activate",function(){try{!n(r)&&r._bakIERange&&r._bakIERange.select()}catch(t){}r._bakIERange=null})),e=t=null};r.prototype={rangeInBody:function(t,e){var n=browser.ie9below||e?t.item?t.item():t.parentElement():t.startContainer;return n===this.document.body||domUtils.inDoc(n,this.document)},getNative:function(){var t=this.document;try{return t?browser.ie9below?t.selection:domUtils.getWindow(t).getSelection():null}catch(e){return null}},getIERange:function(){var t=n(this);return!t&&this._bakIERange?this._bakIERange:t},cache:function(){this.clear(),this._cachedRange=this.getRange(),this._cachedStartElement=this.getStart(),this._cachedStartElementPath=this.getStartElementPath()},getStartElementPath:function(){if(this._cachedStartElementPath)return this._cachedStartElementPath;var t=this.getStart();return t?domUtils.findParents(t,!0,null,!0):[]},clear:function(){this._cachedStartElementPath=this._cachedRange=this._cachedStartElement=null},isFocus:function(){try{if(browser.ie9below){var t=n(this);return!(!t||!this.rangeInBody(t))}return!!this.getNative().rangeCount}catch(e){return!1}},getRange:function(){function t(t){for(var e=n.document.body.firstChild,r=t.collapsed;e&&e.firstChild;)t.setStart(e,0),e=e.firstChild;t.startContainer||t.setStart(n.document.body,0),r&&t.collapse(!0)}var n=this;if(null!=n._cachedRange)return this._cachedRange;var r=new baidu.editor.dom.Range(n.document);if(browser.ie9below){var a=n.getIERange();if(a)try{e(a,r)}catch(i){t(r)}else t(r)}else{var o=n.getNative();if(o&&o.rangeCount){var s=o.getRangeAt(0),l=o.getRangeAt(o.rangeCount-1);r.setStart(s.startContainer,s.startOffset).setEnd(l.endContainer,l.endOffset),r.collapsed&&domUtils.isBody(r.startContainer)&&!r.startOffset&&t(r)}else{if(this._bakRange&&domUtils.inDoc(this._bakRange.startContainer,this.document))return this._bakRange;t(r)}}return this._bakRange=r},getStart:function(){if(this._cachedStartElement)return this._cachedStartElement;var t,e,n,r,a=browser.ie9below?this.getIERange():this.getRange();if(browser.ie9below){if(!a)return this.document.body.firstChild;if(a.item)return a.item(0);for(t=a.duplicate(),t.text.length>0&&t.moveStart("character",1),t.collapse(1),e=t.parentElement(),r=n=a.parentElement();n=n.parentNode;)if(n==e){e=r;break}}else if(a.shrinkBoundary(),e=a.startContainer,1==e.nodeType&&e.hasChildNodes()&&(e=e.childNodes[Math.min(e.childNodes.length-1,a.startOffset)]),3==e.nodeType)return e.parentNode;return e},getText:function(){var t,e;return this.isFocus()&&(t=this.getNative())?(e=browser.ie9below?t.createRange():t.getRangeAt(0),browser.ie9below?e.text:e.toString()):""},clearRange:function(){this.getNative()[browser.ie9below?"empty":"removeAllRanges"]()}}}();