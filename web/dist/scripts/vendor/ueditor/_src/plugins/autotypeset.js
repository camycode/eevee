UE.plugins.autotypeset=function(){function e(e,t){return e&&3!=e.nodeType?domUtils.isBr(e)?1:e&&e.parentNode&&c[e.tagName.toLowerCase()]?r&&r.contains(e)||e.getAttribute("pagebreak")?0:t?!domUtils.isEmptyBlock(e):domUtils.isEmptyBlock(e,new RegExp("[\\s"+domUtils.fillChar+"]","g")):void 0:0}function t(e){e.style.cssText||(domUtils.removeAttributes(e,["style"]),"span"==e.tagName.toLowerCase()&&domUtils.hasNoAttributes(e)&&domUtils.remove(e,!0))}function i(i,n){var s,c=this;if(n){if(!l.pasteFilter)return;s=c.document.createElement("div"),s.innerHTML=n.html}else s=c.document.body;for(var f,g=domUtils.getElementsByTagName(s,"*"),p=0;f=g[p++];)if(c.fireEvent("excludeNodeinautotype",f)!==!0){if(l.clearFontSize&&f.style.fontSize&&(domUtils.removeStyle(f,"font-size"),t(f)),l.clearFontFamily&&f.style.fontFamily&&(domUtils.removeStyle(f,"font-family"),t(f)),e(f)){if(l.mergeEmptyline)for(var u,h=f.nextSibling,y=domUtils.isBr(f);e(h)&&(u=h,h=u.nextSibling,!y||h&&(!h||domUtils.isBr(h)));)domUtils.remove(u);if(l.removeEmptyline&&domUtils.inDoc(f,s)&&!d[f.parentNode.tagName.toLowerCase()]){if(domUtils.isBr(f)&&(h=f.nextSibling,h&&!domUtils.isBr(h)))continue;domUtils.remove(f);continue}}if(e(f,!0)&&"SPAN"!=f.tagName&&(l.indent&&(f.style.textIndent=l.indentValue),l.textAlign&&(f.style.textAlign=l.textAlign)),l.removeClass&&f.className&&!m[f.className.toLowerCase()]){if(r&&r.contains(f))continue;domUtils.removeAttributes(f,["class"])}if(l.imageBlockLine&&"img"==f.tagName.toLowerCase()&&!f.getAttribute("emotion"))if(n){var v=f;switch(l.imageBlockLine){case"left":case"right":case"none":for(var u,U,h,C=v.parentNode;dtd.$inline[C.tagName]||"A"==C.tagName;)C=C.parentNode;if(u=C,"P"==u.tagName&&"center"==domUtils.getStyle(u,"text-align")&&!domUtils.isBody(u)&&1==domUtils.getChildCount(u,function(e){return!domUtils.isBr(e)&&!domUtils.isWhitespace(e)}))if(U=u.previousSibling,h=u.nextSibling,U&&h&&1==U.nodeType&&1==h.nodeType&&U.tagName==h.tagName&&domUtils.isBlockElm(U)){for(U.appendChild(u.firstChild);h.firstChild;)U.appendChild(h.firstChild);domUtils.remove(u),domUtils.remove(h)}else domUtils.setStyle(u,"text-align","");domUtils.setStyle(v,"float",l.imageBlockLine);break;case"center":if("center"!=c.queryCommandValue("imagefloat")){for(C=v.parentNode,domUtils.setStyle(v,"float","none"),u=v;C&&1==domUtils.getChildCount(C,function(e){return!domUtils.isBr(e)&&!domUtils.isWhitespace(e)})&&(dtd.$inline[C.tagName]||"A"==C.tagName);)u=C,C=C.parentNode;var N=c.document.createElement("p");domUtils.setAttributes(N,{style:"text-align:center"}),u.parentNode.insertBefore(N,u),N.appendChild(u),domUtils.setStyle(u,"float","")}}}else{var b=c.selection.getRange();b.selectNode(f).select(),c.execCommand("imagefloat",l.imageBlockLine)}l.removeEmptyNode&&l.removeTagNames[f.tagName.toLowerCase()]&&domUtils.hasNoAttributes(f)&&domUtils.isEmptyBlock(f)&&domUtils.remove(f)}if(l.tobdc){var A=UE.htmlparser(s.innerHTML);A.traversal(function(e){"text"==e.type&&(e.data=a(e.data))}),s.innerHTML=A.toHtml()}if(l.bdc2sb){var A=UE.htmlparser(s.innerHTML);A.traversal(function(e){"text"==e.type&&(e.data=o(e.data))}),s.innerHTML=A.toHtml()}n&&(n.html=s.innerHTML)}function o(e){for(var t="",i=0;i<e.length;i++){var o=e.charCodeAt(i);t+=o>=65281&&65373>=o?String.fromCharCode(e.charCodeAt(i)-65248):12288==o?String.fromCharCode(e.charCodeAt(i)-12288+32):e.charAt(i)}return t}function a(e){e=utils.html(e);for(var t="",i=0;i<e.length;i++)t+=32==e.charCodeAt(i)?String.fromCharCode(12288):e.charCodeAt(i)<127?String.fromCharCode(e.charCodeAt(i)+65248):e.charAt(i);return t}function n(){var e=s.getPreferences("autotypeset");utils.extend(s.options.autotypeset,e)}this.setOpt({autotypeset:{mergeEmptyline:!0,removeClass:!0,removeEmptyline:!1,textAlign:"left",imageBlockLine:"center",pasteFilter:!1,clearFontSize:!1,clearFontFamily:!1,removeEmptyNode:!1,removeTagNames:utils.extend({div:1},dtd.$removeEmpty),indent:!1,indentValue:"2em",bdc2sb:!1,tobdc:!1}});var r,s=this,l=s.options.autotypeset,m={selectTdClass:1,pagebreak:1,anchorclass:1},d={li:1},c={div:1,p:1,blockquote:1,center:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,span:1};l&&(n(),l.pasteFilter&&s.addListener("beforepaste",i),s.commands.autotypeset={execCommand:function(){s.removeListener("beforepaste",i),l.pasteFilter&&s.addListener("beforepaste",i),i.call(s)}})};