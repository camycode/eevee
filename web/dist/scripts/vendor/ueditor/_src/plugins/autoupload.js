UE.plugin.register("autoupload",function(){function e(e,t){var a,r,i,o,n,s,l,d,c=t,u=/image\/\w+/i.test(e.type)?"image":"file",g="loading_"+(+new Date).toString(36);if(a=c.getOpt(u+"FieldName"),r=c.getOpt(u+"UrlPrefix"),i=c.getOpt(u+"MaxSize"),o=c.getOpt(u+"AllowFiles"),n=c.getActionUrl(c.getOpt(u+"ActionName")),l=function(e){var t=c.document.getElementById(g);t&&domUtils.remove(t),c.fireEvent("showmessage",{id:g,content:e,type:"error",timeout:4e3})},"image"==u?(s='<img class="loadingclass" id="'+g+'" src="'+c.options.themePath+c.options.theme+'/images/spacer.gif" title="'+(c.getLang("autoupload.loading")||"")+'" >',d=function(e){var t=r+e.url,a=c.document.getElementById(g);a&&(a.setAttribute("src",t),a.setAttribute("_src",t),a.setAttribute("title",e.title||""),a.setAttribute("alt",e.original||""),a.removeAttribute("id"),domUtils.removeClasses(a,"loadingclass"))}):(s='<p><img class="loadingclass" id="'+g+'" src="'+c.options.themePath+c.options.theme+'/images/spacer.gif" title="'+(c.getLang("autoupload.loading")||"")+'" ></p>',d=function(e){var t=r+e.url,a=c.document.getElementById(g),i=c.selection.getRange(),o=i.createBookmark();i.selectNode(a).select(),c.execCommand("insertfile",{url:t}),i.moveToBookmark(o).select()}),c.execCommand("inserthtml",s),!c.getOpt(u+"ActionName"))return void l(c.getLang("autoupload.errorLoadConfig"));if(e.size>i)return void l(c.getLang("autoupload.exceedSizeError"));var p=e.name?e.name.substr(e.name.lastIndexOf(".")):"";if(p&&"image"!=u||o&&-1==(o.join("")+".").indexOf(p.toLowerCase()+"."))return void l(c.getLang("autoupload.exceedTypeError"));var m=new XMLHttpRequest,f=new FormData,h=utils.serializeParam(c.queryCommandValue("serverparam"))||"",b=utils.formatUrl(n+(-1==n.indexOf("?")?"?":"&")+h);f.append(a,e,e.name||"blob."+e.type.substr("image/".length)),f.append("type","ajax"),m.open("post",b,!0),m.setRequestHeader("X-Requested-With","XMLHttpRequest"),m.addEventListener("load",function(e){try{var t=new Function("return "+utils.trim(e.target.response))();"SUCCESS"==t.state&&t.url?d(t):l(t.state)}catch(a){l(c.getLang("autoupload.loadError"))}}),m.send(f)}function t(e){return e.clipboardData&&e.clipboardData.items&&1==e.clipboardData.items.length&&/^image\//.test(e.clipboardData.items[0].type)?e.clipboardData.items:null}function a(e){return e.dataTransfer&&e.dataTransfer.files?e.dataTransfer.files:null}return{outputRule:function(e){utils.each(e.getNodesByTagName("img"),function(e){/\b(loaderrorclass)|(bloaderrorclass)\b/.test(e.getAttr("class"))&&e.parentNode.removeChild(e)}),utils.each(e.getNodesByTagName("p"),function(e){/\bloadpara\b/.test(e.getAttr("class"))&&e.parentNode.removeChild(e)})},bindEvents:{ready:function(r){var i=this;window.FormData&&window.FileReader&&(domUtils.on(i.body,"paste drop",function(r){var o,n=!1;if(o="paste"==r.type?t(r):a(r)){for(var s,l=o.length;l--;)s=o[l],s.getAsFile&&(s=s.getAsFile()),s&&s.size>0&&(e(s,i),n=!0);n&&r.preventDefault()}}),domUtils.on(i.body,"dragover",function(e){"Files"==e.dataTransfer.types[0]&&e.preventDefault()}),utils.cssRule("loading",".loadingclass{display:inline-block;cursor:default;background: url('"+this.options.themePath+this.options.theme+"/images/loading.gif') no-repeat center center transparent;border:1px solid #cccccc;margin-left:1px;height: 22px;width: 22px;}\n.loaderrorclass{display:inline-block;cursor:default;background: url('"+this.options.themePath+this.options.theme+"/images/loaderror.png') no-repeat center center transparent;border:1px solid #cccccc;margin-right:1px;height: 22px;width: 22px;}",this.document))}}}});