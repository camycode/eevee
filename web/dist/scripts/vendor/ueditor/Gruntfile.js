module.exports=function(s){function e(){var e="ueditor.config.js",t=s.file.read(e),a=n+"/",r="net"===n?".ashx":"."+n;t=t.replace(/php\//gi,a).replace(/\.php/gi,r),"gbk"==c&&(t=t.replace(/utf-8/gi,"gbk")),s.file.write(p+e,t)?s.log.writeln("config file update success"):s.log.warn("config file update error")}var t=require("fs"),a={jsBasePath:"_src/",parseBasePath:"_parse/",cssBasePath:"themes/default/_css/",fetchScripts:function(s,e){var a=t.readFileSync(s);return a=/\[([^\]]+\.js'[^\]]+)\]/.exec(a),a=a[1].replace(/\/\/.*\n/g,"\n").replace(/'|"|\n|\t|\s/g,""),a=a.split(","),a.forEach(function(s,t){a[t]=e+s}),a},fetchStyles:function(){for(var s=t.readFileSync(this.cssBasePath+"ueditor.css"),e=null,a=/@import\s+([^;]+)*;/g,r=[];e=a.exec(s);)r.push(this.cssBasePath+e[1].replace(/'|"/g,""));return r}},r=s.file.readJSON("package.json"),n=s.option("server")||"php",c=s.option("encode")||"utf8",p="dist/",o="/*!\n * UEditor\n * version: "+r.name+"\n * build: <%= new Date() %>\n */\n\n";!function(){n="string"==typeof n?n.toLowerCase():"php",c="string"==typeof c?c.toLowerCase():"utf8",p="dist/"+c+"-"+n+"/"}(),s.initConfig({pkg:r,concat:{js:{options:{banner:o+"(function(){\n\n",footer:"\n\n})();\n",process:function(s,e){var t=e.substr(e.indexOf("/")+1);return"// "+t+"\n"+s.replace("/_css/","/css/")+"\n"}},src:a.fetchScripts("_examples/editor_api.js",a.jsBasePath),dest:p+r.name+".all.js"},parse:{options:{banner:o+"(function(){\n\n",footer:"\n\n})();\n"},src:a.fetchScripts("ueditor.parse.js",a.parseBasePath),dest:p+r.name+".parse.js"},css:{src:a.fetchStyles(),dest:p+"themes/default/css/ueditor.css"}},cssmin:{options:{banner:o},files:{expand:!0,cwd:p+"themes/default/css/",src:["*.css","!*.min.css"],dest:p+"themes/default/css/",ext:".min.css"}},uglify:{options:{banner:o},dest:{src:p+"<%= pkg.name %>.all.js",dest:p+"<%= pkg.name %>.all.min.js"},parse:{src:p+"<%= pkg.name %>.parse.js",dest:p+"<%= pkg.name %>.parse.min.js"}},closurecompiler:{dist:{src:p+"<%= pkg.name %>.all.js",dest:p+"<%= pkg.name %>.all.min.js"},parse:{src:p+"<%= pkg.name %>.parse.js",dest:p+"<%= pkg.name %>.parse.min.js"}},copy:{base:{files:[{src:["*.html","themes/iframe.css","themes/default/dialogbase.css","themes/default/images/**","dialogs/**","lang/**","third-party/**"],dest:p}]},demo:{files:[{src:"_examples/completeDemo.html",dest:p+"index.html"}]},php:{expand:!0,src:"php/**",dest:p},asp:{expand:!0,src:"asp/**",dest:p},jsp:{expand:!0,src:"jsp/**",dest:p},net:{expand:!0,src:"net/**",dest:p}},transcoding:{options:{charset:c},src:[p+"**/*.html",p+"**/*.js",p+"**/*.css",p+"**/*.json",p+"**/*.jsp",p+"**/*.asp"]},replace:{fileEncode:{src:[p+"**/*.html",p+"dialogs/**/*.js",p+"**/*.css",p+"**/*.php",p+"**/*.jsp",p+"**/*.ashx",p+"**/*.asp"],overwrite:!0,replacements:[{from:/utf-8/gi,to:"gbk"}]},demo:{src:p+"index.html",overwrite:!0,replacements:[{from:/\.\.\//gi,to:""},{from:"editor_api.js",to:r.name+".all.min.js"}]},gbkasp:{src:[p+"asp/*.asp"],overwrite:!0,replacements:[{from:/65001/gi,to:"936"}]}},clean:{build:{src:[p+"jsp/src",p+"*/upload",p+".DS_Store",p+"**/.DS_Store",p+".git",p+"**/.git"]}}}),s.loadNpmTasks("grunt-text-replace"),s.loadNpmTasks("grunt-contrib-concat"),s.loadNpmTasks("grunt-contrib-cssmin"),s.loadNpmTasks("grunt-closurecompiler"),s.loadNpmTasks("grunt-contrib-copy"),s.loadNpmTasks("grunt-transcoding"),s.loadNpmTasks("grunt-contrib-clean"),s.registerTask("default","UEditor build",function(){var t=["concat","cssmin","closurecompiler","copy:base","copy:"+n,"copy:demo","replace:demo","clean"];"gbk"===c&&(t.push("replace:fileEncode"),"asp"===n&&t.push("replace:gbkasp")),t.push("transcoding"),e(),s.task.run(t)})};