var gulp=require("gulp"),console=require("better-console"),fs=require("fs"),path=require("path"),git=require("gulp-git"),githubAPI=require("github"),requireDotFile=require("require-dot-file"),github=require("../../config/admin/github.js"),release=require("../../config/admin/release"),project=require("../../config/project/release"),oAuth=fs.existsSync(__dirname+"/../../config/admin/oauth.js")?require("../../config/admin/oauth"):!1,version=project.version;module.exports=function(e){var o,i,n=-1,r=release.distributions.length;return oAuth?(i=function(){function t(){git.exec(w,function(){git.exec(A,function(){git.exec(x,function(){s()})})})}function s(){console.info("Committing "+g+" files",p),gulp.src("./",b).pipe(git.add(b)).pipe(git.commit(v,q)).on("error",function(e){}).on("finish",function(e){k?u():(console.info("Nothing new to commit"),f())})}function u(){console.info("Pushing files for "+g),git.push("origin","master",{args:"",cwd:l},function(e){console.info("Push completed successfully"),c()})}function c(){git.exec(y,function(e,o){o=o.trim(),a(o)})}function a(e){e&&(j.target_commitish=e),github.releases.createRelease(j,function(){f()})}function f(){console.log("Sleeping for 1 second..."),global.clearTimeout(o),o=global.setTimeout(i,500)}if(n+=1,n>=r)return void e();var g=release.distributions[n],l=path.resolve(path.join(release.outputRoot,g.toLowerCase())),d=release.distRepoRoot+g,p=void 0!==oAuth.name&&void 0!==oAuth.email?'--author "'+oAuth.name+" <"+oAuth.email+'>"':"",m=fs.existsSync(l+"package.json")?require(l+"package.json"):!1,h=version&&m.version!=version,v=h?"Updated distribution to version "+version:"Updated files from main repo",b={cwd:l},q={args:p,cwd:l},j={tag_name:version,owner:release.org,repo:d},w={args:"config core.fileMode false",cwd:l},A={args:'config user.name "'+oAuth.name+'"',cwd:l},x={args:'config user.email "'+oAuth.email+'"',cwd:l},y={args:"rev-parse --verify HEAD",cwd:l},R=fs.existsSync(path.join(l,".git")),k=!0;console.info("Processing repository:"+l),R?t():console.error("Repository must be setup before running update distributions")},void i()):void console.error("Must add oauth token for GitHub in tasks/config/admin/oauth.js")};