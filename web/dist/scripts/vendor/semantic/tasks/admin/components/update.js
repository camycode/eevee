var gulp=require("gulp"),console=require("better-console"),fs=require("fs"),path=require("path"),git=require("gulp-git"),githubAPI=require("github"),requireDotFile=require("require-dot-file"),github=require("../../config/admin/github.js"),release=require("../../config/admin/release"),project=require("../../config/project/release"),oAuth=fs.existsSync(__dirname+"/../../config/admin/oauth.js")?require("../../config/admin/oauth"):!1,version=project.version;module.exports=function(e){var o,i,n=-1,t=release.components.length;return oAuth?(i=function(){function r(){git.exec(w,function(){git.exec(x,function(){git.exec(y,function(){s()})})})}function s(){console.info("Committing "+l+" files",h),gulp.src("./",b).pipe(git.add(b)).pipe(git.commit(q,A)).on("error",function(e){}).on("finish",function(e){P?c():(console.info("Nothing new to commit"),g())})}function c(){console.info("Pushing files for "+l),git.push("origin","master",{args:"",cwd:f},function(e){console.info("Push completed successfully"),u()})}function u(){git.exec(R,function(e,o){o=o.trim(),a(o)})}function a(e){e&&(j.target_commitish=e),github.releases.createRelease(j,function(){g()})}function g(){console.log("Sleeping for 1 second..."),global.clearTimeout(o),o=global.setTimeout(i,1e3)}if(n+=1,n>=t)return void e();var l=release.components[n],f=path.resolve(path.join(release.outputRoot,l)),p=l.charAt(0).toUpperCase()+l.slice(1),m=release.componentRepoRoot+p,h=("https://github.com/"+release.org+"/"+m+".git","https://github.com/"+release.org+"/"+m+"/",void 0!==oAuth.name&&void 0!==oAuth.email?'--author "'+oAuth.name+" <"+oAuth.email+'>"':""),d=fs.existsSync(f+"package.json")?require(f+"package.json"):!1,v=version&&d.version!=version,q=v?"Updated component to version "+version:"Updated files from main repo",b={cwd:f},A={args:h,cwd:f},j={tag_name:version,owner:release.org,repo:m},w={args:"config core.fileMode false",cwd:f},x={args:'config user.name "'+oAuth.name+'"',cwd:f},y={args:'config user.email "'+oAuth.email+'"',cwd:f},R={args:"rev-parse --verify HEAD",cwd:f},k=fs.existsSync(path.join(f,".git")),P=!0;console.info("Processing repository:"+f),k?r():console.error("Repository must be setup before running update components")},void i()):void console.error("Must add oauth token for GitHub in tasks/config/admin/oauth.js")};