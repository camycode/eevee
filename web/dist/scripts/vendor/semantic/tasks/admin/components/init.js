var gulp=require("gulp"),console=require("better-console"),del=require("del"),fs=require("fs"),path=require("path"),git=require("gulp-git"),githubAPI=require("github"),mkdirp=require("mkdirp"),github=require("../../config/admin/github.js"),release=require("../../config/admin/release"),project=require("../../config/project/release"),oAuth=fs.existsSync(__dirname+"/../../config/admin/oauth.js")?require("../../config/admin/oauth"):!1,version=project.version;module.exports=function(e){var o,t,i=-1,r=release.components.length;return oAuth?(t=function(){function n(){localRepoSetup?s():u()}function u(){console.info("Initializing repository for "+a),git.init(gitOptions,function(e){e&&console.error("Error initializing repo",e),s()})}function s(){console.info("Adding remote origin as "+gitURL),git.addRemote("origin",gitURL,gitOptions,function(){c()})}function c(){console.info("Pulling "+a+" files"),git.pull("origin","master",pullOptions,function(e){p()})}function p(){console.info("Resetting files to head"),git.reset("HEAD",resetOptions,function(e){l()})}function l(){global.clearTimeout(o),o=global.setTimeout(function(){t()},0)}if(i+=1,i>=r)return void e();var a=release.components[i];outputDirectory=path.resolve(release.outputRoot+a),capitalizedComponent=a.charAt(0).toUpperCase()+a.slice(1),repoName=release.componentRepoRoot+capitalizedComponent,gitOptions={cwd:outputDirectory},pullOptions={args:"-q",cwd:outputDirectory,quiet:!0},resetOptions={args:"-q --hard",cwd:outputDirectory,quiet:!0},gitURL="https://github.com/"+release.org+"/"+repoName+".git",repoURL="https://github.com/"+release.org+"/"+repoName+"/",localRepoSetup=fs.existsSync(path.join(outputDirectory,".git")),console.log("Processing repository: "+outputDirectory),fs.existsSync(outputDirectory)||mkdirp.sync(outputDirectory),0==release.outputRoot.search("../repos")&&(console.info("Cleaning dir",outputDirectory),del.sync([outputDirectory+"**/*"],{silent:!0,force:!0})),localRepoSetup?c():n()},void t()):void console.error("Must add oauth token for GitHub in tasks/config/admin/oauth.js")};