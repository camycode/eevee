var gulp=require("gulp"),console=require("better-console"),del=require("del"),fs=require("fs"),path=require("path"),runSequence=require("run-sequence"),concatFileNames=require("gulp-concat-filenames"),debug=require("gulp-debug"),flatten=require("gulp-flatten"),git=require("gulp-git"),jsonEditor=require("gulp-json-editor"),plumber=require("gulp-plumber"),rename=require("gulp-rename"),replace=require("gulp-replace"),tap=require("gulp-tap"),util=require("gulp-util"),config=require("../../config/user"),release=require("../../config/admin/release"),project=require("../../config/project/release"),version=project.version,output=config.paths.output;module.exports=function(e){var p,t=[];for(p in release.components){var r=release.components[p];!function(e){var p=path.join(release.outputRoot,e),r=fs.existsSync(output.compressed+e+".js"),n=fs.existsSync(output.compressed+e+".css"),s=e.charAt(0).toUpperCase()+e.slice(1),a=release.packageRoot+e,i=release.componentRepoRoot+s,o="https://github.com/"+release.org+"/"+i+".git",c=("https://github.com/"+release.org+"/"+i+"/",{newline:"",root:p,prepend:"    '",append:"',"}),l={match:{name:"{component}",titleName:"{Component}",version:"{version}",files:"{files}",spacedVersions:/(###.*\n)\n+(?=###)/gm,spacedLists:/(^- .*\n)\n+(?=^-)/gm,trim:/^\s+|\s+$/g,unrelatedNotes:new RegExp("^((?!(^.*("+e+").*$|###.*)).)*$","gmi"),whitespace:/\n\s*\n\s*\n/gm,componentExport:/(.*)\$\.fn\.\w+\s*=\s*function\(([^\)]*)\)\s*{/g,componentReference:"$.fn."+e,settingsExport:/\$\.fn\.\w+\.settings\s*=/g,settingsReference:/\$\.fn\.\w+\.settings/g,trailingComma:/,(?=[^,]*$)/,jQuery:/jQuery/g},replace:{name:e,titleName:s,spacedVersions:"",spacedLists:"$1",trim:"",unrelatedNotes:"",whitespace:"\n\n",componentExport:"var _module = module;\n$1module.exports = function($2) {",componentReference:"_module.exports",settingsExport:"module.exports.settings =",settingsReference:"_module.exports.settings",jQuery:'require("jquery")'}},u={all:e+" creating",repo:e+" create repo",bower:e+" create bower.json",readme:e+" create README",npm:e+" create NPM Module",notes:e+" create release notes",composer:e+" create composer.json","package":e+" create package.json",meteor:e+" create meteor package.js"},m={assets:p+"/assets/**/"+e+"?(s).*",component:p+"/"+e+"+(.js|.css)"};gulp.task(u.repo,!1,function(){return gulp.src(release.source+e+".*").pipe(plumber()).pipe(flatten()).pipe(replace(release.paths.source,release.paths.output)).pipe(gulp.dest(p))}),gulp.task(u.npm,!1,function(){return gulp.src(release.source+e+"!(*.min|*.map).js").pipe(plumber()).pipe(flatten()).pipe(replace(l.match.componentExport,l.replace.componentExport)).pipe(replace(l.match.componentReference,l.replace.componentReference)).pipe(replace(l.match.settingsExport,l.replace.settingsExport)).pipe(replace(l.match.settingsReference,l.replace.settingsReference)).pipe(replace(l.match.jQuery,l.replace.jQuery)).pipe(rename("index.js")).pipe(gulp.dest(p))}),gulp.task(u.readme,!1,function(){return gulp.src(release.templates.readme).pipe(plumber()).pipe(flatten()).pipe(replace(l.match.name,l.replace.name)).pipe(replace(l.match.titleName,l.replace.titleName)).pipe(gulp.dest(p))}),gulp.task(u.bower,!1,function(){return gulp.src(release.templates.bower).pipe(plumber()).pipe(flatten()).pipe(jsonEditor(function(p){return p.name=a,p.description=s+" - Semantic UI",r?(n?p.main=[e+".js",e+".css"]:p.main=[e+".js"],p.dependencies={jquery:">=1.8"}):p.main=[e+".css"],p})).pipe(gulp.dest(p))}),gulp.task(u["package"],!1,function(){return gulp.src(release.templates["package"]).pipe(plumber()).pipe(flatten()).pipe(jsonEditor(function(p){return r&&(p.dependencies={jquery:"x.x.x"},p.main="index.js"),p.name=a,version&&(p.version=version),p.title="Semantic UI - "+s,p.description="Single component release of "+e,p.repository={type:"git",url:o},p})).pipe(gulp.dest(p))}),gulp.task(u.composer,!1,function(){return gulp.src(release.templates.composer).pipe(plumber()).pipe(flatten()).pipe(jsonEditor(function(p){return r&&(p.dependencies={jquery:"x.x.x"},p.main=e+".js"),p.name="semantic/"+e,version&&(p.version=version),p.description="Single component release of "+e,p})).pipe(gulp.dest(p))}),gulp.task(u.notes,!1,function(){return gulp.src(release.templates.notes).pipe(plumber()).pipe(flatten()).pipe(replace(l.match.unrelatedNotes,l.replace.unrelatedNotes)).pipe(replace(l.match.whitespace,l.replace.whitespace)).pipe(replace(l.match.spacedVersions,l.replace.spacedVersions)).pipe(replace(l.match.spacedLists,l.replace.spacedLists)).pipe(replace(l.match.trim,l.replace.trim)).pipe(gulp.dest(p))}),gulp.task(u.meteor,function(){var e="";return gulp.src(m.component).pipe(concatFileNames("empty.txt",c)).pipe(tap(function(p){e+=p.contents})).on("end",function(){gulp.src(m.assets).pipe(concatFileNames("empty.txt",c)).pipe(tap(function(p){e+=p.contents})).on("end",function(){e=e.replace(l.match.trailingComma,"").trim(),gulp.src(release.templates.meteor.component).pipe(plumber()).pipe(flatten()).pipe(replace(l.match.name,l.replace.name)).pipe(replace(l.match.titleName,l.replace.titleName)).pipe(replace(l.match.version,version)).pipe(replace(l.match.files,e)).pipe(rename(release.files.meteor)).pipe(gulp.dest(p))})})}),gulp.task(u.all,!1,function(e){runSequence([u.repo,u.npm,u.bower,u.readme,u["package"],u.composer,u.notes,u.meteor],e)}),t.push(u.all)}(r)}runSequence(t,e)};