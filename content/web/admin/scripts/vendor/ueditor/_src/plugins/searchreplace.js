UE.plugin.register("searchreplace",function(){function e(e,t,r){var n=t.searchStr;-1==t.dir&&(e=e.split("").reverse().join(""),n=n.split("").reverse().join(""),r=e.length-r);for(var i,o=new RegExp(n,"g"+(t.casesensitive?"":"i"));i=o.exec(e);)if(i.index>=r)return-1==t.dir?e.length-i.index-t.searchStr.length:i.index;return-1}function t(t,r,n){var i,o,a=n.all||1==n.dir?"getNextDomNode":"getPreDomNode";domUtils.isBody(t)&&(t=t.firstChild);for(var d=1;t;){if(i=3==t.nodeType?t.nodeValue:t[browser.ie?"innerText":"textContent"],o=e(i,n,r),d=0,-1!=o)return{node:t,index:o};for(t=domUtils[a](t);t&&s[t.nodeName.toLowerCase()];)t=domUtils[a](t,!0);t&&(r=-1==n.dir?(3==t.nodeType?t.nodeValue:t[browser.ie?"innerText":"textContent"]).length:0)}}function r(e,t,n){for(var i,o=0,s=e.firstChild,a=0;s;){if(3==s.nodeType){if(a=s.nodeValue.replace(/(^[\t\r\n]+)|([\t\r\n]+$)/,"").length,o+=a,o>=t)return{node:s,index:a-(o-t)}}else if(!dtd.$empty[s.tagName]&&(a=s[browser.ie?"innerText":"textContent"].replace(/(^[\t\r\n]+)|([\t\r\n]+$)/,"").length,o+=a,o>=t&&(i=r(s,a-(o-t),n))))return i;s=domUtils.getNextDomNode(s)}}function n(e,n){var o,s=e.selection.getRange(),a=n.searchStr,d=e.document.createElement("span");if(d.innerHTML="$$ueditor_searchreplace_key$$",s.shrinkBoundary(!0),!s.collapsed){s.select();var l=e.selection.getText();if(new RegExp("^"+n.searchStr+"$",n.casesensitive?"":"i").test(l)){if(void 0!=n.replaceStr)return i(s,n.replaceStr),s.select(),!0;s.collapse(-1==n.dir)}}s.insertNode(d),s.enlargeToBlockElm(!0),o=s.startContainer;var c=o[browser.ie?"innerText":"textContent"].indexOf("$$ueditor_searchreplace_key$$");s.setStartBefore(d),domUtils.remove(d);var f=t(o,c,n);if(f){var v=r(f.node,f.index,a),u=r(f.node,f.index+a.length,a);return s.setStart(v.node,v.index).setEnd(u.node,u.index),void 0!==n.replaceStr&&i(s,n.replaceStr),s.select(),!0}s.setCursor()}function i(e,t){t=o.document.createTextNode(t),e.deleteContents().insertNode(t)}var o=this,s={table:1,tbody:1,tr:1,ol:1,ul:1};return{commands:{searchreplace:{execCommand:function(e,t){utils.extend(t,{all:!1,casesensitive:!1,dir:1},!0);var r=0;if(t.all){var i=o.selection.getRange(),s=o.body.firstChild;for(s&&1==s.nodeType?(i.setStart(s,0),i.shrinkBoundary(!0)):3==s.nodeType&&i.setStartBefore(s),i.collapse(!0).select(!0),void 0!==t.replaceStr&&o.fireEvent("saveScene");n(this,t);)r++;r&&o.fireEvent("saveScene")}else void 0!==t.replaceStr&&o.fireEvent("saveScene"),n(this,t)&&r++,r&&o.fireEvent("saveScene");return r},notNeedUndo:1}}}});