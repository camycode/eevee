UE.plugins.undo=function(){function t(t,e){if(t.length!=e.length)return 0;for(var n=0,i=t.length;i>n;n++)if(t[n]!=e[n])return 0;return 1}function e(e,n){return e.collapsed!=n.collapsed?0:t(e.startAddress,n.startAddress)&&t(e.endAddress,n.endAddress)?1:0}function n(){this.list=[],this.index=0,this.hasUndo=!1,this.hasRedo=!1,this.undo=function(){if(this.hasUndo){if(!this.list[this.index-1]&&1==this.list.length)return void this.reset();for(;this.list[this.index].content==this.list[this.index-1].content;)if(this.index--,0==this.index)return this.restore(0);this.restore(--this.index)}},this.redo=function(){if(this.hasRedo){for(;this.list[this.index].content==this.list[this.index+1].content;)if(this.index++,this.index==this.list.length-1)return this.restore(this.index);this.restore(++this.index)}},this.restore=function(){var t=this.editor,e=this.list[this.index],n=UE.htmlparser(e.content.replace(d,""));t.options.autoClearEmptyNode=!1,t.filterInputRule(n),t.options.autoClearEmptyNode=h,t.document.body.innerHTML=n.toHtml(),t.fireEvent("afterscencerestore"),browser.ie&&utils.each(domUtils.getElementsByTagName(t.document,"td th caption p"),function(e){domUtils.isEmptyNode(e)&&domUtils.fillNode(t.document,e)});try{var i=new dom.Range(t.document).moveToAddress(e.address);i.select(a[i.startContainer.nodeName.toLowerCase()])}catch(s){}this.update(),this.clearKey(),t.fireEvent("reset",!0)},this.getScene=function(){var t=this.editor,e=t.selection.getRange(),n=e.createAddress(!1,!0);t.fireEvent("beforegetscene");var i=UE.htmlparser(t.body.innerHTML);t.options.autoClearEmptyNode=!1,t.filterOutputRule(i),t.options.autoClearEmptyNode=h;var s=i.toHtml();return t.fireEvent("aftergetscene"),{address:n,content:s}},this.save=function(t,n){clearTimeout(i);var r=this.getScene(n),d=this.list[this.index];d&&d.content!=r.content&&s.trigger("contentchange"),d&&d.content==r.content&&(t?1:e(d.address,r.address))||(this.list=this.list.slice(0,this.index+1),this.list.push(r),this.list.length>o&&this.list.shift(),this.index=this.list.length-1,this.clearKey(),this.update())},this.update=function(){this.hasRedo=!!this.list[this.index+1],this.hasUndo=!!this.list[this.index-1]},this.reset=function(){this.list=[],this.index=0,this.hasUndo=!1,this.hasRedo=!1,this.clearKey()},this.clearKey=function(){u=0,l=null}}var i,s=this,o=s.options.maxUndoCount||20,r=s.options.maxInputCount||20,d=new RegExp(domUtils.fillChar+"|</hr>","gi"),a={ol:1,ul:1,table:1,tbody:1,tr:1,body:1},h=s.options.autoClearEmptyNode;s.undoManger=new n,s.undoManger.editor=s,s.addListener("saveScene",function(){var t=Array.prototype.splice.call(arguments,1);this.undoManger.save.apply(this.undoManger,t)}),s.addListener("reset",function(t,e){e||this.undoManger.reset()}),s.commands.redo=s.commands.undo={execCommand:function(t){this.undoManger[t]()},queryCommandState:function(t){return this.undoManger["has"+("undo"==t.toLowerCase()?"Undo":"Redo")]?0:-1},notNeedUndo:1};var l,c={16:1,17:1,18:1,37:1,38:1,39:1,40:1},u=0,f=!1;s.addListener("ready",function(){domUtils.on(this.body,"compositionstart",function(){f=!0}),domUtils.on(this.body,"compositionend",function(){f=!1})}),s.addshortcutkey({Undo:"ctrl+90",Redo:"ctrl+89"});var m=!0;s.addListener("keydown",function(t,e){function n(t){t.undoManger.save(!1,!0),t.fireEvent("selectionchange")}var s=this,o=e.keyCode||e.which;if(!(c[o]||e.ctrlKey||e.metaKey||e.shiftKey||e.altKey)){if(f)return;if(!s.selection.getRange().collapsed)return s.undoManger.save(!1,!0),void(m=!1);0==s.undoManger.list.length&&s.undoManger.save(!0),clearTimeout(i),i=setTimeout(function(){if(f)var t=setInterval(function(){f||(n(s),clearInterval(t))},300);else n(s)},200),l=o,u++,u>=r&&n(s)}}),s.addListener("keyup",function(t,e){var n=e.keyCode||e.which;if(!(c[n]||e.ctrlKey||e.metaKey||e.shiftKey||e.altKey)){if(f)return;m||(this.undoManger.save(!1,!0),m=!0)}}),s.stopCmdUndo=function(){s.__hasEnterExecCommand=!0},s.startCmdUndo=function(){s.__hasEnterExecCommand=!1}};